<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLOOM LUXE SALON</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Prompt', sans-serif; }
    
    /* Animation */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.2); }
      50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.6); }
    }
    .queue-active { animation: pulse-glow 2s infinite; border: 1px solid rgba(139, 92, 246, 0.5); }
    
    /* Glass Effect */
    .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.05);
    }
    .glass-input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        color: white;
        outline: none;
        transition: all 0.3s;
    }
    .glass-input:focus { border-color: #a78bfa; box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2); }
    
    /* Radio Box */
    .radio-box {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.2s;
    }
    .radio-box:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(139, 92, 246, 0.4); }
    .radio-box input:checked + span { color: #d8b4fe; font-weight: 600; }
    
    /* Tabs */
    .tab-btn { background: rgba(139, 92, 246, 0.1); color: #a78bfa; transition: all 0.3s; }
    .tab-btn.active { background: linear-gradient(135deg, #8B5CF6, #6D28D9); color: white; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
    
    .hidden-elm { display: none !important; }

    /* Badges */
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-waiting { background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3); }
    .status-serving { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-completed { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.3); }

    .queue-number { font-family: 'Courier New', monospace; letter-spacing: -1px; }
  </style>
 </head>
 <body class="h-full m-0 p-0 bg-[#0f172a]">
  
  <div id="app" class="h-full w-full overflow-auto min-h-screen" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
    
    <!-- Top Bar Navigation -->
    <nav class="flex justify-between items-center px-6 py-4 bg-black/20 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üå∏</span>
            <span class="text-white font-bold tracking-wider hidden md:block">BLOOM LUXE</span>
        </div>
        <div class="flex gap-2">
            <button onclick="showPage('customer')" id="nav-customer" class="px-4 py-2 rounded-lg text-sm font-medium bg-purple-600 text-white shadow-lg shadow-purple-500/30 transition-all">
                Customer
            </button>
            <button onclick="showPage('admin')" id="nav-admin" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-400 hover:text-white transition-all">
                Staff Only
            </button>
        </div>
    </nav>

    <!-- ================= CUSTOMER PAGE ================= -->
    <div id="page-customer" class="max-w-2xl mx-auto px-4 pb-12 pt-6 animate-slide-in">
      
      <!-- Intro Card -->
      <div class="glass-panel rounded-3xl p-6 mb-6 text-center relative overflow-hidden">
         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500"></div>
         <h2 class="text-xl font-bold text-white mb-1">Your Needs Test</h2>
         <p class="text-purple-200/70 text-sm">‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
      </div>

      <!-- Customer Menu Tabs -->
      <div class="flex gap-4 mb-6">
          <button onclick="switchCustomerView('form')" id="btn-view-form" class="flex-1 py-3 rounded-2xl font-bold transition-all bg-white text-purple-900 shadow-lg scale-105">
              üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
          </button>
          <button onclick="switchCustomerView('queue')" id="btn-view-queue" class="flex-1 py-3 rounded-2xl font-bold transition-all bg-white/10 text-purple-300 hover:bg-white/20">
              üëÄ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
          </button>
      </div>

      <!-- 1. Form View -->
      <div id="customer-form-view" class="glass-panel rounded-3xl p-6 md:p-8 shadow-2xl animate-slide-in">
        <form id="customer-form" class="space-y-8">
            <!-- Type Switcher -->
            <div class="flex bg-black/20 p-1.5 rounded-2xl">
                <button type="button" onclick="switchFormTab('walkin')" id="tab-walkin" class="flex-1 py-3 rounded-xl font-medium text-sm transition-all tab-btn active">üö∂ Walk-in</button>
                <button type="button" onclick="switchFormTab('booking')" id="tab-booking" class="flex-1 py-3 rounded-xl font-medium text-sm transition-all tab-btn">üìÖ Booking</button>
            </div>
            <input type="hidden" id="form-order-type" name="orderType" value="walkin">

            <!-- Booking Fields -->
            <div id="booking-section" class="hidden-elm p-5 rounded-2xl border border-dashed border-purple-500/40 bg-purple-500/5">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-purple-200/70 text-xs mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="booking-date" name="bookingDate" class="glass-input"></div>
                    <div><label class="block text-purple-200/70 text-xs mb-2">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" id="booking-time" name="bookingTime" class="glass-input"></div>
                </div>
            </div>

            <!-- Inputs -->
            <div>
                <label class="block text-purple-200 text-sm mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / Nickname</label>
                <input type="text" id="nickname" name="nickname" required class="glass-input" placeholder="‡∏Ñ‡∏∏‡∏ì...">
            </div>

            <div>
                <label class="block text-purple-200 text-sm mb-2">‡πÄ‡∏û‡∏®</label>
                <div class="flex gap-3">
                    <label class="radio-box flex-1 justify-center"><input type="radio" name="gender" value="‡∏ä‡∏≤‡∏¢ (Male)" required class="accent-purple-500"><span class="text-gray-300 text-sm">‡∏ä‡∏≤‡∏¢</span></label>
                    <label class="radio-box flex-1 justify-center"><input type="radio" name="gender" value="‡∏´‡∏ç‡∏¥‡∏á (Female)" class="accent-purple-500"><span class="text-gray-300 text-sm">‡∏´‡∏ç‡∏¥‡∏á</span></label>
                </div>
            </div>

            <div class="w-full h-px bg-white/10"></div>

            <!-- Preferences -->
            <div class="space-y-6">
                 <div><label class="block text-purple-200 text-sm mb-3">üå°Ô∏è ‡∏ô‡πâ‡∏≥</label>
                    <div class="flex gap-3">
                        <label class="radio-box flex-1 justify-center"><input type="radio" name="waterTemp" value="‡∏≠‡∏∏‡πà‡∏ô" required class="accent-purple-500"><span class="text-gray-300 text-sm">‡∏≠‡∏∏‡πà‡∏ô</span></label>
                        <label class="radio-box flex-1 justify-center"><input type="radio" name="waterTemp" value="‡πÄ‡∏¢‡πá‡∏ô" class="accent-purple-500"><span class="text-gray-300 text-sm">‡πÄ‡∏¢‡πá‡∏ô</span></label>
                    </div>
                 </div>
                 <div><label class="block text-purple-200 text-sm mb-3">üåø ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="radio-box"><input type="radio" name="oil" value="Jasmine Rice" required class="accent-purple-500"><span class="text-gray-300 text-xs">‡∏Ç‡πâ‡∏≤‡∏ß</span></label>
                        <label class="radio-box"><input type="radio" name="oil" value="White Tea" class="accent-purple-500"><span class="text-gray-300 text-xs">‡πÑ‡∏ß‡∏ó‡πå‡∏ó‡∏µ</span></label>
                        <label class="radio-box"><input type="radio" name="oil" value="Marigold" class="accent-purple-500"><span class="text-gray-300 text-xs">‡∏°‡∏≤‡∏£‡∏¥‡πÇ‡∏Å‡∏•‡∏î‡πå</span></label>
                        <label class="radio-box"><input type="radio" name="oil" value="Orchid" class="accent-purple-500"><span class="text-gray-300 text-xs">‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ</span></label>
                    </div>
                 </div>
                 <div><label class="block text-purple-200 text-sm mb-3">üß¥ ‡πÅ‡∏ä‡∏°‡∏û‡∏π</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="radio-box justify-center"><input type="radio" name="shampoo" value="Chance Rich" required class="accent-purple-500"><span class="text-gray-300 text-xs">Chance</span></label>
                        <label class="radio-box justify-center"><input type="radio" name="shampoo" value="Honey Sunset" class="accent-purple-500"><span class="text-gray-300 text-xs">Honey</span></label>
                        <label class="radio-box justify-center"><input type="radio" name="shampoo" value="Pink Gold" class="accent-purple-500"><span class="text-gray-300 text-xs">Pink</span></label>
                    </div>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-purple-200 text-sm mb-2">‡∏ô‡∏ß‡∏î‡∏ï‡∏±‡∏ß</label>
                        <select id="massage-p" name="massagePressure" class="glass-input"><option>‡πÄ‡∏ö‡∏≤</option><option>‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏´‡∏ô‡∏±‡∏Å</option></select>
                    </div>
                    <div><label class="block text-purple-200 text-sm mb-2">‡πÄ‡∏Å‡∏≤‡∏®‡∏µ‡∏£‡∏©‡∏∞</label>
                        <select id="head-p" name="headPressure" class="glass-input"><option>‡πÄ‡∏ö‡∏≤</option><option>‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏´‡∏ô‡∏±‡∏Å</option></select>
                    </div>
                 </div>
                 <div><label class="block text-purple-200 text-sm mb-2">‚ö†Ô∏è ‡∏à‡∏∏‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á</label><textarea id="caution" name="caution" rows="2" class="glass-input"></textarea></div>
            </div>

            <button type="submit" id="submit-btn" class="w-full py-4 rounded-xl font-bold text-white text-lg bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg shadow-purple-500/30 transition-all hover:scale-[1.02]">
                <span id="submit-text">‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
        </form>
      </div>

      <!-- 2. Live Queue View (Customer) -->
      <div id="customer-queue-view" class="hidden-elm animate-slide-in">
          
          <!-- Big Serving Display -->
          <div class="glass-panel p-6 rounded-3xl text-center mb-6 relative overflow-hidden bg-gradient-to-br from-purple-900/40 to-black/40">
            <div class="text-purple-200 text-sm uppercase tracking-widest mb-2 animate-pulse">Now Serving</div>
            <div class="text-6xl md:text-8xl font-bold text-green-400 queue-number mb-2" id="cust-display-queue">-</div>
            <div class="text-xl text-white font-bold" id="cust-display-name">...</div>
          </div>

          <!-- Waiting List -->
          <h3 class="text-white font-bold mb-4 flex items-center gap-2">
              <span>‚è≥</span> ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ (Waiting List)
          </h3>
          <div id="cust-waiting-list" class="space-y-3">
              <div class="text-center text-gray-500 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>

          <p class="text-center text-gray-500 text-xs mt-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
      </div>

    </div>

    <!-- ================= ADMIN PAGE ================= -->
    <div id="page-admin" class="hidden-elm max-w-4xl mx-auto px-4 pb-12 pt-6 animate-slide-in">
        
        <!-- Big Queue Display (Admin) -->
        <div class="glass-panel p-6 rounded-3xl text-center mb-6 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 to-transparent"></div>
            <div class="relative z-10">
                <div class="text-purple-200 text-sm uppercase tracking-widest mb-2">Now Serving (Staff View)</div>
                <div class="text-6xl md:text-8xl font-bold text-white queue-number mb-2" id="display-current-queue">-</div>
                <div class="text-xl text-purple-300" id="display-current-name">Waiting...</div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="glass-panel p-4 rounded-2xl text-center">
                <div class="text-3xl font-bold text-yellow-400" id="count-waiting">0</div>
                <div class="text-xs text-gray-400">Waiting</div>
            </div>
            <div class="glass-panel p-4 rounded-2xl text-center">
                <div class="text-3xl font-bold text-green-400" id="count-serving">0</div>
                <div class="text-xs text-gray-400">Serving</div>
            </div>
            <div class="glass-panel p-4 rounded-2xl text-center">
                <div class="text-3xl font-bold text-blue-400" id="count-total">0</div>
                <div class="text-xs text-gray-400">Total Today</div>
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß</h2>
            <button onclick="fetchOrders(true)" class="px-4 py-2 rounded-lg bg-white/10 text-purple-300 hover:bg-white/20 transition-all text-sm flex items-center gap-2">
                üîÑ Refresh
            </button>
        </div>

        <!-- Order List Container -->
        <div id="order-list" class="space-y-4">
            <div class="text-center text-gray-500 py-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="hidden-elm fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-2xl w-80 text-center">
            <h3 class="text-xl font-bold text-white mb-4">üîê Staff Login</h3>
            <input type="password" id="admin-pass" class="glass-input text-center mb-4" placeholder="Enter Password">
            <button onclick="checkLogin()" class="w-full py-3 bg-purple-600 text-white rounded-xl font-bold">Login</button>
            <button onclick="showPage('customer')" class="mt-4 text-sm text-gray-400">Cancel</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 right-4 z-[70] space-y-2 pointer-events-none"></div>

  </div>

  <script>
    // ==========================================
    // ‚ö†Ô∏è ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script (Backend)
    // ==========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6zZDyO8-j0CNRE5dWpHqhIOjdtGaqbEpGDajxR0j6h4wZb1MvND9vSf4jeqpWPXwPjg/exec'; 

    let lastRenderedData = null; 
    let activePage = 'customer';
    let activeCustomerTab = 'form';

    window.onload = function() {
        setInterval(() => {
            if (activePage === 'admin' || (activePage === 'customer' && activeCustomerTab === 'queue')) {
                fetchOrders(false);
            }
        }, 15000);
    };

    // Navigation System
    function showPage(page) {
        activePage = page;
        if(page === 'admin') {
            document.getElementById('login-modal').classList.remove('hidden-elm');
        } else {
            document.getElementById('page-customer').classList.remove('hidden-elm');
            document.getElementById('page-admin').classList.add('hidden-elm');
            
            document.getElementById('nav-customer').classList.add('bg-purple-600', 'text-white');
            document.getElementById('nav-customer').classList.remove('text-gray-400');
            document.getElementById('nav-admin').classList.remove('bg-purple-600', 'text-white');
            document.getElementById('nav-admin').classList.add('text-gray-400');
            
            document.getElementById('login-modal').classList.add('hidden-elm');
        }
    }

    function switchCustomerView(view) {
        activeCustomerTab = view;
        const btnForm = document.getElementById('btn-view-form');
        const btnQueue = document.getElementById('btn-view-queue');
        const viewForm = document.getElementById('customer-form-view');
        const viewQueue = document.getElementById('customer-queue-view');

        if (view === 'form') {
            btnForm.classList.add('bg-white', 'text-purple-900', 'scale-105', 'shadow-lg');
            btnForm.classList.remove('bg-white/10', 'text-purple-300');
            btnQueue.classList.add('bg-white/10', 'text-purple-300');
            btnQueue.classList.remove('bg-white', 'text-purple-900', 'scale-105', 'shadow-lg');
            viewForm.classList.remove('hidden-elm');
            viewQueue.classList.add('hidden-elm');
        } else {
            btnQueue.classList.add('bg-white', 'text-purple-900', 'scale-105', 'shadow-lg');
            btnQueue.classList.remove('bg-white/10', 'text-purple-300');
            btnForm.classList.add('bg-white/10', 'text-purple-300');
            btnForm.classList.remove('bg-white', 'text-purple-900', 'scale-105', 'shadow-lg');
            viewForm.classList.add('hidden-elm');
            viewQueue.classList.remove('hidden-elm');
            fetchOrders(true);
        }
    }

    function checkLogin() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === '1234') { 
            document.getElementById('login-modal').classList.add('hidden-elm');
            document.getElementById('page-customer').classList.add('hidden-elm');
            document.getElementById('page-admin').classList.remove('hidden-elm');
            
            document.getElementById('nav-admin').classList.add('bg-purple-600', 'text-white');
            document.getElementById('nav-admin').classList.remove('text-gray-400');
            document.getElementById('nav-customer').classList.remove('bg-purple-600', 'text-white');
            document.getElementById('nav-customer').classList.add('text-gray-400');
            
            fetchOrders(true);
        } else {
            alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
    }

    function switchFormTab(type) {
        document.getElementById('form-order-type').value = type;
        const bookingSec = document.getElementById('booking-section');
        const bookingInputs = bookingSec.querySelectorAll('input');
        
        if (type === 'booking') {
            document.getElementById('tab-booking').classList.add('active');
            document.getElementById('tab-walkin').classList.remove('active');
            bookingSec.classList.remove('hidden-elm');
            bookingInputs.forEach(i => i.required = true);
            document.getElementById('submit-text').innerText = 'üìÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
        } else {
            document.getElementById('tab-walkin').classList.add('active');
            document.getElementById('tab-booking').classList.remove('active');
            bookingSec.classList.add('hidden-elm');
            bookingInputs.forEach(i => i.required = false);
            document.getElementById('submit-text').innerText = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Walk-in)';
        }
    }

    // --- SEND DATA TO GOOGLE SHEET (Using fetch) ---
    document.getElementById('customer-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        document.getElementById('submit-text').innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

        const form = document.getElementById('customer-form');
        const formData = new FormData(form);
        // ‡πÅ‡∏õ‡∏•‡∏á FormData ‡πÄ‡∏õ‡πá‡∏ô URLSearchParams ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Google Apps Script ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ
        const params = new URLSearchParams(formData);
        params.append('action', 'submitOrder');

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: params
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success'){
                showToast('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                form.reset();
                setTimeout(() => switchCustomerView('queue'), 1500);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(err => {
            showToast('Error: ' + err.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            document.getElementById('submit-text').innerText = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        });
    });

    // --- FETCH ORDERS (Using fetch) ---
    function fetchOrders(showLoading = false) {
        const loadingHtml = '<div class="text-center text-gray-500 py-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
        if(showLoading) {
            if(activePage === 'admin') document.getElementById('order-list').innerHTML = loadingHtml;
            if(activePage === 'customer' && activeCustomerTab === 'queue') document.getElementById('cust-waiting-list').innerHTML = loadingHtml;
        }
        
        fetch(SCRIPT_URL)
        .then(response => response.json())
        .then(orders => onDataReceived(orders))
        .catch(err => console.error(err));
    }

    function onDataReceived(orders) {
        const currentDataStr = JSON.stringify(orders);
        if (currentDataStr === lastRenderedData) return;
        lastRenderedData = currentDataStr;

        let waiting = 0;
        let serving = 0;
        let currentServingQueue = null;
        const waitingList = [];

        if(orders) {
            orders.forEach(o => {
                o.queueId = `Q-${String(o.rowId).padStart(3, '0')}`;
                if(o.status === 'Waiting') {
                    waiting++;
                    waitingList.push(o);
                }
                if(o.status === 'Serving') {
                    serving++;
                    if (!currentServingQueue) currentServingQueue = o;
                }
            });
        }

        if(activePage === 'admin') {
            renderAdminView(orders, waiting, serving, currentServingQueue);
        }
        renderCustomerQueueView(waitingList, currentServingQueue);
    }

    function renderCustomerQueueView(waitingList, servingQueue) {
        const dispQueue = document.getElementById('cust-display-queue');
        const dispName = document.getElementById('cust-display-name');

        if (servingQueue) {
            dispQueue.innerText = servingQueue.queueId;
            dispName.innerText = servingQueue.nickname;
        } else {
            dispQueue.innerText = "-";
            dispName.innerText = "Waiting...";
        }

        const listContainer = document.getElementById('cust-waiting-list');
        listContainer.innerHTML = '';

        if(waitingList.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-gray-500 py-4 bg-white/5 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ (No Waiting Queue)</div>';
        } else {
            waitingList.sort((a,b) => a.rowId - b.rowId).forEach(o => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-white/5 rounded-xl border border-white/5';
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="font-mono text-xl font-bold text-white">${o.queueId}</div>
                        <div class="text-gray-300">${o.nickname}</div>
                    </div>
                    <div class="px-3 py-1 bg-yellow-500/20 text-yellow-300 text-xs rounded-full">Waiting</div>
                `;
                listContainer.appendChild(item);
            });
        }
    }

    function renderAdminView(orders, waiting, serving, servingQueue) {
        const container = document.getElementById('order-list');
        container.innerHTML = '';
        
        document.getElementById('count-waiting').innerText = waiting;
        document.getElementById('count-serving').innerText = serving;
        document.getElementById('count-total').innerText = orders ? orders.length : 0;

        if (servingQueue) {
            document.getElementById('display-current-queue').innerText = servingQueue.queueId;
            document.getElementById('display-current-name').innerText = servingQueue.nickname;
            document.getElementById('display-current-queue').classList.add('text-green-400');
        } else {
            document.getElementById('display-current-queue').innerText = '-';
            document.getElementById('display-current-name').innerText = 'Waiting...';
            document.getElementById('display-current-queue').classList.remove('text-green-400');
        }

        if(!orders || orders.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
            return;
        }

        const fragment = document.createDocumentFragment();
        orders.forEach(o => {
            const statusClass = o.status === 'Waiting' ? 'status-waiting' : 
                                o.status === 'Serving' ? 'status-serving queue-active' : 'status-completed';
            const timeDisplay = o.orderType === 'booking' ? `üìÖ ${o.bookingDate} ${o.bookingTime}` : `üïí Walk-in`;
            
            const card = document.createElement('div');
            card.className = `glass-panel p-5 rounded-2xl animate-slide-in relative ${o.status === 'Serving' ? 'border-purple-500/50 bg-purple-500/5' : ''}`;
            card.innerHTML = `
                <div class="absolute top-4 right-4 text-xs font-mono text-white/30">#${o.rowId}</div>
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/10 px-3 py-2 rounded-lg text-xl font-bold text-white font-mono border border-white/10">
                            ${o.queueId}
                        </div>
                        <div>
                            <div class="text-lg font-bold text-white flex items-center gap-2">
                                ${o.nickname} <span class="text-xs font-normal text-gray-400">(${o.gender})</span>
                            </div>
                            <div class="text-sm text-purple-300 mt-1">${timeDisplay}</div>
                        </div>
                    </div>
                    <span class="status-badge ${statusClass}">${o.status}</span>
                </div>
                <div class="bg-black/20 p-3 rounded-xl text-sm text-gray-300 grid grid-cols-2 gap-2 mb-4">
                    <div>üå°Ô∏è ‡∏ô‡πâ‡∏≥: <span class="text-white">${o.waterTemp}</span></div>
                    <div>üåø ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: <span class="text-white">${o.oil}</span></div>
                    <div>üß¥ ‡πÅ‡∏ä‡∏°‡∏û‡∏π: <span class="text-white">${o.shampoo}</span></div>
                    <div>üíÜ ‡∏ô‡∏ß‡∏î: <span class="text-white">${o.massagePressure}</span></div>
                    <div>üíÜ‚Äç‚ôÄÔ∏è ‡∏´‡∏±‡∏ß: <span class="text-white">${o.headPressure}</span></div>
                    <div class="col-span-2 text-yellow-200 text-xs">‚ö†Ô∏è ${o.caution || '-'}</div>
                </div>
                <div class="flex gap-2 justify-end">
                    ${o.status === 'Waiting' ? `<button onclick="updateStatus(${o.rowId}, 'Serving')" class="px-4 py-2 bg-green-600/80 hover:bg-green-600 text-white rounded-lg text-sm font-bold transition-all">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß (Start)</button>` : ''}
                    ${o.status === 'Serving' ? `<button onclick="updateStatus(${o.rowId}, 'Completed')" class="px-4 py-2 bg-blue-600/80 hover:bg-blue-600 text-white rounded-lg text-sm font-bold transition-all">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Finish)</button>` : ''}
                    ${o.status !== 'Completed' ? `<button onclick="updateStatus(${o.rowId}, 'Cancelled')" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/40 text-red-300 rounded-lg text-sm transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                </div>
            `;
            fragment.appendChild(card);
        });
        container.appendChild(fragment);
    }

    // --- UPDATE STATUS (Using fetch) ---
    function updateStatus(rowId, status) {
        if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status}?`)) return;
        
        // ‡∏™‡πà‡∏á POST request ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏ action 'updateStatus'
        const params = new URLSearchParams();
        params.append('action', 'updateStatus');
        params.append('rowId', rowId);
        params.append('status', status);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: params
        })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                lastRenderedData = null; 
                fetchOrders(false);
            }
        })
        .catch(err => showToast('Error: ' + err, 'error'));
    }

    function showToast(message, type) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      let bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      toast.className = `animate-slide-in px-6 py-3 rounded-xl shadow-lg text-white font-medium ${bg}`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
 </body>
</html>
